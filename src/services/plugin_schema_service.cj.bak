package lrr4cj.services

import std.collection.*
import stdx.encoding.json.*
import lrr4cj.dao.*
import lrr4cj.config.*
import lrr4cj.utils.*
import stdx.log.*
import std.convert.*
import std.fs.*

/**
 * 插件参数Schema定义
 */
public class PluginParameterSchema {
    public var paramType: String = ""           // 参数类型: string, int, bool, float
    public var desc: String = ""           // 参数描述
    public var defaultValue: String = ""   // 默认值
    public var required: Bool = false      // 是否必填
    public var min: String = ""            // 最小值 (数值类型)
    public var max: String = ""            // 最大值 (数值类型)
    public var enumValues: Array<String> = Array<String>()  // 枚举值
    public var format: String = ""         // 格式: password, url, email等
    public var pattern: String = ""        // 正则表达式模式
    public var minLength: String = ""      // 最小长度
    public var maxLength: String = ""      // 最大长度
    public var title: String = ""          // 参数标题
    public var helpText: String = ""       // 帮助文本

    public init() {}

    /**
     * 从简单格式创建Schema (向后兼容)
     */
    public static func fromLegacy(`type`: String, desc: String): PluginParameterSchema {
        var schema = PluginParameterSchema()
        schema.paramType = `type`
        schema.desc = desc
        schema.title = desc
        return schema
    }

    /**
     * 转换为JSON Schema对象
     */
    public func toJsonSchema(): JsonObject {
        var jsonSchema = JsonObject()

        // 设置基本类型
        match (paramType) {
            case "string" => jsonSchema["type"] = JsonString("string")
            case "bool" => jsonSchema["type"] = JsonString("boolean")
            case "int" => jsonSchema["type"] = JsonString("integer")
            case "float" => jsonSchema["type"] = JsonString("number")
            case _ => jsonSchema["type"] = JsonString("string")
        }

        // 设置标题和描述
        if (title.size > 0) {
            jsonSchema["title"] = JsonString(title)
        }
        if (desc.size > 0) {
            jsonSchema["description"] = JsonString(desc)
        }

        // 设置默认值
        if (defaultValue.size > 0) {
            match (paramType) {
                case "bool" => jsonSchema["default"] = if (defaultValue == "true" || defaultValue == "1") { JsonBool(true) } else { JsonBool(false) }
                case "int" => jsonSchema["default"] = JsonInt64(Int64.parse(defaultValue) ?? 0)
                case "float" => jsonSchema["default"] = JsonFloat64(Float64.parse(defaultValue) ?? 0.0)
                case _ => jsonSchema["default"] = JsonString(defaultValue)
            }
        }

        // 设置是否必填
        if (required) {
            // 必填字段在父级schema中处理
        }

        // 设置数值约束
        if (min.size > 0) {
            match (paramType) {
                case "int" => jsonSchema["minimum"] = JsonInt64(Int64.parse(min) ?? 0)
                case "float" => jsonSchema["minimum"] = JsonFloat64(Float64.parse(min) ?? 0.0)
                case _ => ()
            }
        }

        if (max.size > 0) {
            match (paramType) {
                case "int" => jsonSchema["maximum"] = JsonInt64(Int64.parse(max) ?? 0)
                case "float" => jsonSchema["maximum"] = JsonFloat64(Float64.parse(max) ?? 0.0)
                case _ => ()
            }
        }

        // 设置枚举值
        if (enumValues.size > 0) {
            var enumArray = JsonArray()
            for (value in enumValues) {
                match (paramType) {
                    case "bool" => enumArray.append(if (value == "true" || value == "1") { JsonBool(true) } else { JsonBool(false) })
                    case "int" => enumArray.append(JsonInt64(Int64.parse(value) ?? 0))
                    case "float" => enumArray.append(JsonFloat64(Float64.parse(value) ?? 0.0))
                    case _ => enumArray.append(JsonString(value))
                }
            }
            jsonSchema["enum"] = enumArray
        }

        // 设置字符串格式
        if (format.size > 0) {
            jsonSchema["format"] = JsonString(format)
        }

        // 设置正则表达式
        if (pattern.size > 0) {
            jsonSchema["pattern"] = JsonString(pattern)
        }

        // 设置字符串长度约束
        if (minLength.size > 0) {
            jsonSchema["minLength"] = JsonInt64(Int64.parse(minLength) ?? 0)
        }

        if (maxLength.size > 0) {
            jsonSchema["maxLength"] = JsonInt64(Int64.parse(maxLength) ?? 0)
        }

        return jsonSchema
    }

    /**
     * 转换为UI Schema对象
     */
    public func toUiSchema(): JsonObject {
        var uiSchema = JsonObject()

        // 设置UI组件类型
        match (paramType) {
            case "bool" => uiSchema["ui:widget"] = JsonString("checkbox")
            case "string" => {
                if (enumValues.size > 0) {
                    uiSchema["ui:widget"] = JsonString("select")
                } else if (format == "password") {
                    uiSchema["ui:widget"] = JsonString("password")
                } else if (format == "url") {
                    uiSchema["ui:widget"] = JsonString("url")
                } else if (maxLength.size > 0 || maxLength.toInt64() > 100) {
                    uiSchema["ui:widget"] = JsonString("textarea")
                }
            }
            case "int" | "float" => uiSchema["ui:widget"] = JsonString("number")
            case _ => ()
        }

        // 设置帮助文本
        if (helpText.size > 0) {
            uiSchema["ui:help"] = JsonString(helpText)
        }

        return uiSchema
    }
}

/**
 * 插件Schema服务
 * 负责解析Perl插件参数定义并生成JSON Schema
 */
public class PluginSchemaService {
    private static var instance: Option<PluginSchemaService> = Option.None

    private init() {}

    /**
     * 获取单例实例
     */
    public static func getInstance(): PluginSchemaService {
        match (instance) {
            case Some(service) => return service
            case None =>
                let service = PluginSchemaService()
                instance = Some(service)
                return service
        }
    }

    /**
     * 从插件参数定义生成JSON Schema
     */
    public func generateParameterSchema(parameters: JsonObject): (JsonObject, JsonObject, Array<String>) {
        let logger = getLogger("plugin_schema_service")
        var jsonSchema = JsonObject()
        var uiSchema = JsonObject()
        var requiredFields = Array<String>()

        logger.info("开始生成插件参数Schema")

        // 检查参数格式
        if (parameters.getFields().contains("parameters")) {
            let paramsValueOption = parameters.getFields().get("parameters")
        match (paramsValueOption) {
            case Some(paramsValue) => {
            match (paramsValue) {
                case jsonArray: JsonArray =>
                    // 数组格式: [{ type => "string", desc => "description" }, ...]
                    logger.debug("解析数组格式的参数定义")
                    var properties = JsonObject()

                    for (i in 0..jsonArray.size) {
                        let paramValue = jsonArray[i]
                        match (paramValue) {
                            case jsonObj: JsonObject =>
                                let typeStr = getJsonString(jsonObj, "type") ?? "string"
                                let descStr = getJsonString(jsonObj, "desc") ?? ""

                                // 为数组格式生成参数名
                                let paramName = "param_${(i + 1).toString()}"
                                let paramSchema = PluginParameterSchema.fromLegacy(typeStr, descStr)

                                properties[paramName] = paramSchema.toJsonSchema()

                                // 添加UI Schema
                                uiSchema[paramName] = paramSchema.toUiSchema()
                            case _ =>
                                logger.warn("参数定义格式错误，跳过")
                        }
                    }

                    jsonSchema["type"] = JsonString("object")
                    jsonSchema["properties"] = properties

                case jsonObject: JsonObject =>
                    // 对象格式: { param_name => { type => "string", desc => "description" }, ... }
                    logger.debug("解析对象格式的参数定义")
                    var properties = JsonObject()

                    for ((paramName, paramValue) in jsonObject.getFields()) {
                        match (paramValue) {
                            case paramObj: JsonObject =>
                                let paramSchema = parseParameterObject(paramObj, paramName)
                                properties[paramName] = paramSchema.toJsonSchema()
                                uiSchema[paramName] = paramSchema.toUiSchema()

                                if (paramSchema.required) {
                                    requiredFields.append(paramName)
                                }
                            case _ =>
                                logger.warn("参数 ${paramName} 定义格式错误，使用默认格式")
                                let paramSchema = PluginParameterSchema.fromLegacy("string", paramValue.toString())
                                properties[paramName] = paramSchema.toJsonSchema()
                                uiSchema[paramName] = paramSchema.toUiSchema()
                        }
                    }

                    jsonSchema["type"] = JsonString("object")
                    jsonSchema["properties"] = properties

                    if (requiredFields.size > 0) {
                        var requiredArray = JsonArray()
                        for (field in requiredFields) {
                            requiredArray.append(JsonString(field))
                        }
                        jsonSchema["required"] = requiredArray
                    }

                case _ =>
                    logger.warn("parameters字段格式错误，使用空Schema")
            }
        } else {
            logger.debug("插件没有参数定义")
        }

        logger.info("参数Schema生成完成", ("properties_count", jsonSchema.getFields().size.toString()))

        return (jsonSchema, uiSchema, requiredFields)
    }

    /**
     * 解析参数对象
     */
    private func parseParameterObject(paramObj: JsonObject, paramName: String): PluginParameterSchema {
        let logger = getLogger("plugin_schema_service")
        var schema = PluginParameterSchema()

        // 基本字段映射
        schema.paramType = getJsonString(paramObj, "type") ?? "string"
        schema.desc = getJsonString(paramObj, "desc") ?? ""
        schema.title = getJsonString(paramObj, "title") ?? schema.desc
        schema.defaultValue = getJsonString(paramObj, "default_value") ?? getJsonString(paramObj, "default") ?? ""
        schema.required = getJsonString(paramObj, "required") == "true"
        schema.format = getJsonString(paramObj, "format") ?? ""
        schema.pattern = getJsonString(paramObj, "pattern") ?? ""
        schema.helpText = getJsonString(paramObj, "help_text") ?? getJsonString(paramObj, "help") ?? ""

        // 数值约束
        schema.min = getJsonString(paramObj, "min") ?? getJsonString(paramObj, "minimum") ?? ""
        schema.max = getJsonString(paramObj, "max") ?? getJsonString(paramObj, "maximum") ?? ""

        // 字符串长度约束
        schema.minLength = getJsonString(paramObj, "min_length") ?? getJsonString(paramObj, "minLength") ?? ""
        schema.maxLength = getJsonString(paramObj, "max_length") ?? getJsonString(paramObj, "maxLength") ?? ""

        // 枚举值
        if (paramObj.getFields().contains("enum")) {
            let enumValue = paramObj.getFields()["enum"]!
            match (enumValue) {
                case enumArray: JsonArray =>
                    for (item in enumArray) {
                        match (item) {
                            case str: JsonString => schema.enumValues.append(str.getValue())
                            case _ => schema.enumValues.append(item.toString())
                        }
                    }
                case str: JsonString =>
                    // 如果enum是字符串，按逗号分割
                    let enumStr = str.getValue()
                    if (enumStr.contains(",")) {
                        let parts = enumStr.split(",")
                        for (part in parts) {
                            schema.enumValues.append(part.trim())
                        }
                    } else {
                        schema.enumValues.append(enumStr)
                    }
                case _ => ()
            }
        }

        logger.debug("解析参数", ("name", paramName), ("type", schema.type), ("default", schema.defaultValue))

        return schema
    }

    /**
     * 生成默认配置值
     */
    public func generateDefaultConfig(jsonSchema: JsonObject): HashMap<String, String> {
        var defaultConfig = HashMap<String, String>()

        if (jsonSchema.getFields().contains("properties")) {
            let properties = jsonSchema.getFields()["properties"]!
            match (properties) {
                case propsObj: JsonObject =>
                    for ((paramName, paramSchema) in propsObj.getFields()) {
                        match (paramSchema) {
                            case schemaObj: JsonObject =>
                                if (schemaObj.getFields().contains("default")) {
                                    let defaultValue = schemaObj.getFields()["default"]!
                                    match (defaultValue) {
                                        case str: JsonString => defaultConfig[paramName] = str.getValue()
                                        case bool: JsonBool => defaultConfig[paramName] = if (bool.getValue()) { "true" } else { "false" }
                                        case num: JsonInt64 => defaultConfig[paramName] = num.getValue().toString()
                                        case num: JsonFloat64 => defaultConfig[paramName] = num.getValue().toString()
                                        case _ => defaultConfig[paramName] = defaultValue.toString()
                                    }
                                }
                            case _ => ()
                        }
                    }
                case _ => ()
            }
        }

        return defaultConfig
    }

    /**
     * 验证配置值是否符合Schema
     */
    public func validateConfig(config: HashMap<String, String>, jsonSchema: JsonObject): (Bool, String) {
        let logger = getLogger("plugin_schema_service")

        if (!jsonSchema.getFields().contains("properties")) {
            return (true, "") // 没有Schema则认为有效
        }

        let properties = jsonSchema.getFields()["properties"]!
        match (properties) {
            case propsObj: JsonObject =>
                // 检查必填字段
                if (jsonSchema.getFields().contains("required")) {
                    let required = jsonSchema.getFields()["required"]!
                    match (required) {
                        case requiredArray: JsonArray =>
                            for (item in requiredArray) {
                                match (item) {
                                    case fieldName: JsonString =>
                                        let paramName = fieldName.getValue()
                                        if (!config.contains(paramName)) {
                                            return (false, "缺少必填参数: ${paramName}")
                                        }
                                    case _ => ()
                                }
                            }
                        case _ => ()
                    }
                }

                // 验证每个参数
                for ((paramName, paramValue) in config) {
                    if (!propsObj.getFields().contains(paramName)) {
                        logger.warn("配置参数 ${paramName} 不在Schema定义中")
                        continue
                    }

                    let schemaValue = propsObj.getFields()[paramName]!
                    match (schemaValue) {
                        case schemaObj: JsonObject =>
                            let validationResult = validateParameterValue(paramValue, schemaObj)
                            if (!validationResult.valid) {
                                return (false, "参数 ${paramName} 验证失败: ${validationResult.error}")
                            }
                        case _ => ()
                    }
                }

                return (true, "")
            case _ =>
                return (false, "Schema格式错误：properties不是对象")
        }
    }

    /**
     * 验证单个参数值
     */
    private func validateParameterValue(value: String, schema: JsonObject): (Bool, String) {
        // 获取参数类型
        let paramType = getJsonString(schema, "type") ?? "string"

        // 类型验证
        match (paramType) {
            case "boolean" =>
                if (value != "true" && value != "false" && value != "1" && value != "0") {
                    return (false, "必须是布尔值 (true/false)")
                }
            case "integer" =>
                if (Int64.parse(value) == None) {
                    return (false, "必须是整数")
                }
            case "number" =>
                if (Float64.parse(value) == None) {
                    return (false, "必须是数字")
                }
            case _ => () // 字符串类型总是有效
        }

        // 枚举值验证
        if (schema.getFields().contains("enum")) {
            let enumValue = schema.getFields()["enum"]!
            match (enumValue) {
                case enumArray: JsonArray =>
                    var found = false
                    for (item in enumArray) {
                        if (item.toString() == value) {
                            found = true
                            break
                        }
                    }
                    if (!found) {
                        return (false, "值必须在预定义选项中")
                    }
                case _ => ()
            }
        }

        // 数值范围验证
        if (paramType == "integer" || paramType == "number") {
            let numValue = if (paramType == "integer") {
                Float64.parse(value) ?? 0.0
            } else {
                Float64.parse(value) ?? 0.0
            }

            if (schema.getFields().contains("minimum")) {
                let minValue = schema.getFields()["minimum"]!
                match (minValue) {
                    case minNum: JsonInt64 | minNum: JsonFloat64 =>
                        if (numValue < Float64.parse(minValue.toString()) ?? 0.0) {
                            return (false, "值不能小于 ${minValue.toString()}")
                        }
                    case _ => ()
                }
            }

            if (schema.getFields().contains("maximum")) {
                let maxValue = schema.getFields()["maximum"]!
                match (maxValue) {
                    case maxNum: JsonInt64 | maxNum: JsonFloat64 =>
                        if (numValue > Float64.parse(maxValue.toString()) ?? 0.0) {
                            return (false, "值不能大于 ${maxValue.toString()}")
                        }
                    case _ => ()
                }
            }
        }

        // 字符串长度验证
        if (paramType == "string") {
            let strLength = value.size

            if (schema.getFields().contains("minLength")) {
                let minLength = schema.getFields()["minLength"]!
                match (minLength) {
                    case minNum: JsonInt64 =>
                        if (strLength < minNum.getValue()) {
                            return (false, "长度不能少于 ${minNum.getValue().toString()} 个字符")
                        }
                    case _ => ()
                }
            }

            if (schema.getFields().contains("maxLength")) {
                let maxLength = schema.getFields()["maxLength"]!
                match (maxLength) {
                    case maxNum: JsonInt64 =>
                        if (strLength > maxNum.getValue()) {
                            return (false, "长度不能超过 ${maxNum.getValue().toString()} 个字符")
                        }
                    case _ => ()
                }
            }

            // 正则表达式验证
            if (schema.getFields().contains("pattern")) {
                let pattern = schema.getFields()["pattern"]!
                match (pattern) {
                    case patternStr: JsonString =>
                        // 仓颉目前没有内置正则表达式，这里做简单检查
                        // 实际实现中可能需要调用外部库或Perl的正则表达式
                        logger = getLogger("plugin_schema_service")
                        logger.debug("正则表达式验证暂未实现", ("pattern", patternStr.getValue()))
                    case _ => ()
                }
            }
        }

        return (true, "")
    }

    /**
     * 从JsonObject获取字符串值
     */
    private func getJsonString(jsonObj: JsonObject, key: String): Option<String> {
        if (jsonObj.getFields().contains(key)) {
            let value = jsonObj.getFields()[key]!
            match (value) {
                case jsonStr: JsonString =>
                    Some(jsonStr.getValue())
                case _ =>
                    Some(value.toString())
            }
        } else {
            None
        }
    }
}